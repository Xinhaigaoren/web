<!DOCTYPE html>
<html>
<head>
    <title>Â§ö‰∫∫ÂÆûÊó∂‰ΩçÁΩÆÂÖ±‰∫´</title>
    <style>
        :root {
            --primary-color: #3b82f6;
            --error-color: #ef4444;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        #map {
            width: 100%;
            height: 600px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            background: #f8fafc;
        }

        .player-marker {
            width: 40px;
            height: 40px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .marker-content {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-color);
            position: relative;
        }

        .current-user .marker-content {
            background: #10b981;
        }

        .direction {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 10px solid white;
            position: absolute;
            top: -5px;
        }

        .username {
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            white-space: nowrap;
        }

        .error {
            color: var(--error-color);
            margin-top: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Â§ö‰∫∫ÂÆûÊó∂‰ΩçÁΩÆÂÖ±‰∫´Á≥ªÁªü</h1>
        
        <div class="input-section">
            <input type="text" id="username" placeholder="Áî®Êà∑Âêç" required>
            <input type="number" id="x" placeholder="XÂùêÊ†á" min="0" required>
            <input type="number" id="y" placeholder="YÂùêÊ†á" min="0" required>
            <input type="number" id="angle" placeholder="ËßíÂ∫¶ (0-360)" min="0" max="360" required>
            <button onclick="handlePositionUpdate()">Êõ¥Êñ∞‰ΩçÁΩÆ</button>
        </div>
        <div id="error" class="error"></div>

        <div id="map"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ÂàùÂßãÂåñÈÖçÁΩÆ
        const SUPABASE_URL = 'https://ouzvzbwmygtktqzjltmp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91enZ6YndteWd0a3RxempsdG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwMDA3NzIsImV4cCI6MjA1ODU3Njc3Mn0.QEk7NZG9qBLovTHzT9mNhl__PqfqxCoQs26AlLhaGnY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const userId = localStorage.getItem('userId') || crypto.randomUUID();
        let currentChannel = null;

        // ÂàùÂßãÂåñÁî®Êà∑
        localStorage.setItem('userId', userId);
        document.getElementById('username').value = `Áé©ÂÆ∂_${userId.slice(0,4)}`;

        // ÂÆûÊó∂ËÆ¢ÈòÖ
        function initRealtime() {
            if (currentChannel) currentChannel.unsubscribe();
            
            currentChannel = supabase
                .channel('public:positions')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'positions'
                }, handleRealtimeUpdate)
                .subscribe();
        }

        // Â§ÑÁêÜÂÆûÊó∂Êõ¥Êñ∞
        function handleRealtimeUpdate(payload) {
            const { eventType, new: newData } = payload;
            const markerId = `player-${newData.user_id}`;
            
            switch(eventType) {
                case 'INSERT':
                    createPlayerMarker(newData);
                    break;
                case 'UPDATE':
                    updatePlayerMarker(newData);
                    break;
                case 'DELETE':
                    removePlayerMarker(markerId);
                    break;
            }
        }

        // ÂàõÂª∫Áé©ÂÆ∂Ê†áËÆ∞
        function createPlayerMarker(data) {
            const marker = document.createElement('div');
            marker.className = `player-marker ${data.user_id === userId ? 'current-user' : ''}`;
            marker.id = `player-${data.user_id}`;
            
            marker.innerHTML = `
                <div class="marker-content">
                    <div class="direction"></div>
                </div>
                <div class="username">${data.username}</div>
            `;

            updateMarkerPosition(marker, data);
            document.getElementById('map').appendChild(marker);
        }

        // Êõ¥Êñ∞Ê†áËÆ∞‰ΩçÁΩÆ
        function updateMarkerPosition(marker, data) {
            marker.style.left = `${data.x}px`;
            marker.style.top = `${data.y}px`;
            marker.querySelector('.direction').style.transform = `rotate(${data.angle}deg)`;
        }

        // Êõ¥Êñ∞Áé©ÂÆ∂Ê†áËÆ∞
        function updatePlayerMarker(data) {
            const marker = document.getElementById(`player-${data.user_id}`);
            if (marker) updateMarkerPosition(marker, data);
        }

        // Âà†Èô§Áé©ÂÆ∂Ê†áËÆ∞
        function removePlayerMarker(markerId) {
            const marker = document.getElementById(markerId);
            if (marker) marker.remove();
        }

        // Â§ÑÁêÜ‰ΩçÁΩÆÊõ¥Êñ∞
        async function handlePositionUpdate() {
            const username = document.getElementById('username').value.trim();
            const x = parseInt(document.getElementById('x').value);
            const y = parseInt(document.getElementById('y').value);
            const angle = parseInt(document.getElementById('angle').value);
            const errorElement = document.getElementById('error');

            // ËæìÂÖ•È™åËØÅ
            if (!username || isNaN(x) || isNaN(y) || isNaN(angle)) {
                errorElement.textContent = 'ËØ∑Â°´ÂÜôÊâÄÊúâÊúâÊïàÂ≠óÊÆµ';
                return;
            }
            errorElement.textContent = '';

            try {
                // Â∞ùËØïÊèíÂÖ•Êñ∞ËÆ∞ÂΩï
                const { error: insertError } = await supabase
                    .from('positions')
                    .insert({
                        user_id: userId,
                        username,
                        x,
                        y,
                        angle
                    });

                // ÊèíÂÖ•Â§±Ë¥•ÂàôÊõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩï
                if (insertError) {
                    const { error: updateError } = await supabase
                        .from('positions')
                        .update({ x, y, angle })
                        .eq('user_id', userId);
                    
                    if (updateError) throw updateError;
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Â§±Ë¥•:', error);
                errorElement.textContent = 'Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
            }
        }

        // ÂàùÂßãÂåñ
        window.addEventListener('DOMContentLoaded', () => {
            initRealtime();
            // Âä†ËΩΩÁé∞ÊúâÁé©ÂÆ∂‰ΩçÁΩÆ
            supabase
                .from('positions')
                .select('*')
                .then(({ data }) => {
                    data.forEach(createPlayerMarker);
                });
        });
    </script>
        <!-- Âú®ÂéüÊúâHTMLÁªìÊûÑ‰∏≠Ê∑ªÂä†‰ª•‰∏ãÂÖÉÁ¥† -->
    <div id="feedback-container">
        <div id="success-toast" class="toast">‚úì ‰ΩçÁΩÆÊõ¥Êñ∞ÊàêÂäü</div>
        <div id="loading-indicator" class="toast">üîÑ Êõ¥Êñ∞‰∏≠...</div>
    </div>

    <style>
        /* Êñ∞Â¢ûÊ†∑Âºè */
        .toast {
            position: fixed;
            top: 20px;
            right: -300px;
            background: #fff;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #success-toast {
            border-left: 4px solid #10b981;
        }

        #loading-indicator {
            border-left: 4px solid #3b82f6;
            display: none;
        }

        .success-animation {
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</body>
</html>